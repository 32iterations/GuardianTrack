<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GuardianTrack - 即時定位</title>
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        /* 確保地圖填滿框架 */
        #map-container {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 10;
        }
        /* 自訂患者移動點的樣式 */
        .patient-marker {
            width: 20px;
            height: 20px;
            background-color: #3b82f6; /* Blue-500 */
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
            transition: background-color 0.5s ease;
        }
        .patient-marker.warning {
            background-color: #f97316; /* Orange-500 */
            box-shadow: 0 0 15px rgba(249, 115, 22, 1);
        }
        /* 讓圖標稍微跳動，增加視覺焦點 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .home-icon, .destination-icon {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen page-transition">

    <!-- 手機 UI 框架 -->
    <div class="w-full max-w-sm h-[800px] bg-gray-100 rounded-3xl shadow-2xl overflow-hidden flex flex-col border-4 border-black">
        
        <!-- 主要內容區域 (地圖和浮動UI) -->
        <main class="flex-1 relative">
            
            <!-- 地圖容器 -->
            <div id="map-container">
                <div id="map"></div>
            </div>

            <!-- 浮動頂部導覽列 -->
            <header class="absolute top-0 left-0 right-0 p-4 z-20">
                <div class="bg-white/80 backdrop-blur-md rounded-xl shadow-md p-3 flex items-center justify-between">
                    <a href="./index.html" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </a>
                    <h1 class="text-base font-bold text-gray-800">即時定位：<span class="text-blue-600">陳秀英</span></h1>
                    <div class="w-10 h-10"></div> <!-- 佔位符 -->
                </div>
            </header>
            
            <!-- 浮動底部資訊與控制面板 -->
            <div class="absolute bottom-0 left-0 right-0 p-4 z-20">
                <div class="bg-white rounded-2xl shadow-lg p-4 space-y-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-lg text-gray-800">監控中</p>
                            <p id="last-updated" class="text-xs text-gray-500">最後更新：-</p>
                        </div>
                        <div id="status-indicator" class="w-4 h-4 bg-green-500 rounded-full animate-pulse"></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <button id="recenter-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mx-auto" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
                            <span class="text-xs font-semibold mt-1">置中</span>
                        </button>
                        <button class="bg-gray-100 hover:bg-gray-200 text-gray-700 p-2 rounded-lg transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mx-auto" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.885.511a1.745 1.745 0 0 1 2.61.163L6.29 2.98c.329.423.445.974.315 1.494l-.547 2.19a.678.678 0 0 0 .178.643l2.457 2.457a.678.678 0 0 0 .644.178l2.189-.547a1.745 1.745 0 0 1 1.494.315l2.306 1.794c.829.645.905 1.87.163 2.611l-1.034 1.034c-.74.74-1.846 1.065-2.877.702a18.634 18.634 0 0 1-7.01-4.42 18.634 18.634 0 0 1-4.42-7.009c-.362-1.03-.037-2.137.703-2.877L1.885.511z"/></svg>
                            <span class="text-xs font-semibold mt-1">通話</span>
                        </button>
                        <button id="start-simulation" class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-lg transition-colors">
                             <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="mx-auto" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M6.271 5.055a.5.5 0 0 1 .52.038l3.5 2.5a.5.5 0 0 1 0 .814l-3.5 2.5A.5.5 0 0 1 6 10.5v-5a.5.5 0 0 1 .271-.445z"/></svg>
                            <span id="simulation-text" class="text-xs font-semibold mt-1">模擬</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Leaflet.js JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- 變數定義 ---
        const homeCoords = [24.8113, 120.9715];
        const destinationCoords = [24.8035, 120.9920];
        const mapCenter = [24.8074, 120.98175];
        const normalPath = [[24.8113, 120.9715], [24.8110, 120.9725], [24.8105, 120.9740], [24.8090, 120.9750], [24.8085, 120.9775], [24.8078, 120.9800], [24.8070, 120.9820], [24.8065, 120.9845], [24.8055, 120.9870], [24.8045, 120.9895], [24.8035, 120.9920]];
        const wanderingPath = [[24.8070, 120.9820], [24.8072, 120.9825], [24.8068, 120.9828], [24.8071, 120.9823], [24.8073, 120.9826], [24.8069, 120.9829], [24.8070, 120.9821]];
        const deviationPointIndex = 6;

        let map;
        let patientMarker;
        let predictionPathLayers = []; 
        let normalPathPolyline, warningPathPolyline, alertMarker = null;
        let animationFrameId;

        // --- 初始化函式 ---
        function initializeMap() {
            map = L.map('map').setView(mapCenter, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

            L.marker(homeCoords, { icon: L.divIcon({ className: 'home-icon', html: '<div class="w-6 h-6 bg-green-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg></div>', iconSize: [24, 24], iconAnchor: [12, 24] }) }).addTo(map).bindPopup('<b>家 (起點)</b>');
            L.marker(destinationCoords, { icon: L.divIcon({ className: 'destination-icon', html: '<div class="w-6 h-6 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 21l-4.95-6.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></div>', iconSize: [24, 24], iconAnchor: [12, 24] }) }).addTo(map).bindPopup('<b>失智據點 (目的地)</b>');
            
            normalPathPolyline = L.polyline(normalPath, { color: 'rgba(100, 100, 100, 0.6)', weight: 3, dashArray: '5, 10' }).addTo(map);
            patientMarker = L.marker(homeCoords, { icon: L.divIcon({ className: 'patient-marker', iconSize: [20, 20] }) }).addTo(map);
        }

        // --- 動畫函式 ---
        function startSimulation() {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            if (warningPathPolyline) map.removeLayer(warningPathPolyline);
            if (alertMarker) { map.removeLayer(alertMarker); alertMarker = null; }
            predictionPathLayers.forEach(layer => map.removeLayer(layer));
            predictionPathLayers = [];
            patientMarker.setLatLng(homeCoords);
            patientMarker.getElement().classList.remove('warning');
            
            document.getElementById('start-simulation').disabled = true;
            document.getElementById('simulation-text').textContent = "模擬中";

            let startTime = null;
            const totalDuration = 20000;
            const segmentDuration = totalDuration / normalPath.length;

            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                
                const now = new Date();
                document.getElementById('last-updated').textContent = `最後更新：${now.toLocaleTimeString()}`;

                const pathIndex = Math.min(Math.floor(progress / segmentDuration), normalPath.length - 2);
                if (pathIndex >= deviationPointIndex) { startWanderingAnimation(); return; }
                
                const segmentProgress = (progress % segmentDuration) / segmentDuration;
                const startPoint = normalPath[pathIndex];
                const endPoint = normalPath[pathIndex + 1];
                const lat = startPoint[0] + (endPoint[0] - startPoint[0]) * segmentProgress;
                const lng = startPoint[1] + (endPoint[1] - startPoint[1]) * segmentProgress;
                const currentPos = [lat, lng];
                patientMarker.setLatLng(currentPos);
                map.panTo(currentPos, { animate: false });
                updatePredictionPath(currentPos, endPoint); // 重新加入熱力圖更新
                animationFrameId = requestAnimationFrame(animate);
            }
            animationFrameId = requestAnimationFrame(animate);
        }
        
        function startWanderingAnimation() {
            cancelAnimationFrame(animationFrameId);
            predictionPathLayers.forEach(layer => map.removeLayer(layer));
            predictionPathLayers = [];
            const wanderingPoints = [normalPath[deviationPointIndex]];
            warningPathPolyline = L.polyline(wanderingPoints, { color: '#9ca3af', weight: 5, dashArray: '5,5' }).addTo(map);
            
            let startTime = null;
            const wanderDuration = 10000;
            const totalWanderLength = wanderingPath.length;
            const segmentDuration = wanderDuration / totalWanderLength;
            let suspicionTriggered = false;
            let alertTriggered = false;

            function animateWander(timestamp) {
                if (!startTime) startTime = timestamp;
                const progress = timestamp - startTime;
                
                const now = new Date();
                document.getElementById('last-updated').textContent = `最後更新：${now.toLocaleTimeString()}`;

                if (progress > 3000 && !suspicionTriggered) {
                    patientMarker.getElement().classList.add('warning');
                    document.getElementById('status-indicator').classList.remove('bg-green-500');
                    document.getElementById('status-indicator').classList.add('bg-orange-500');
                    if (warningPathPolyline) {
                        warningPathPolyline.setStyle({ color: '#f97316', dashArray: null });
                    }
                    suspicionTriggered = true;
                }

                if (progress > 6000 && !alertTriggered) {
                    showAlertOnMap();
                    alertTriggered = true;
                }

                if(progress >= wanderDuration) { resetSimulationButton(); return; }
                
                const pathIndex = Math.min(Math.floor(progress / segmentDuration), totalWanderLength - 2);
                const segmentProgress = (progress % segmentDuration) / segmentDuration;
                const startPoint = wanderingPath[pathIndex];
                const endPoint = wanderingPath[pathIndex + 1];
                const lat = startPoint[0] + (endPoint[0] - startPoint[0]) * segmentProgress;
                const lng = startPoint[1] + (endPoint[1] - startPoint[1]) * segmentProgress;
                const currentPos = [lat, lng];
                patientMarker.setLatLng(currentPos);
                warningPathPolyline.addLatLng(currentPos);
                animationFrameId = requestAnimationFrame(animateWander);
            }
            animationFrameId = requestAnimationFrame(animateWander);
        }
        
        // --- 輔助函式 ---
        function updatePredictionPath(currentPos, nextPoint) {
            predictionPathLayers.forEach(layer => map.removeLayer(layer));
            predictionPathLayers = [];
            const pathProbabilityBands = [ { color: '#27ae60', weight: 70, opacity: 0.2 }, { color: '#2ecc71', weight: 60, opacity: 0.25 }, { color: '#f1c40f', weight: 50, opacity: 0.3 }, { color: '#e67e22', weight: 40, opacity: 0.35 }, { color: '#e74c3c', weight: 30, opacity: 0.4 }, { color: '#c0392b', weight: 20, opacity: 0.5 } ];
            const predictionSegment = [currentPos, nextPoint];
            pathProbabilityBands.forEach(band => {
                const pathLayer = L.polyline(predictionSegment, { color: band.color, weight: band.weight, opacity: band.opacity, lineCap: 'round', lineJoin: 'round' }).addTo(map);
                predictionPathLayers.push(pathLayer);
            });
            const centerLine = L.polyline(predictionSegment, { color: 'black', weight: 2, opacity: 0.8, dashArray: '5, 5' }).addTo(map);
            predictionPathLayers.push(centerLine);
        }
        
        function showAlertOnMap() {
            if (alertMarker) { map.removeLayer(alertMarker); }
             document.getElementById('status-indicator').classList.remove('bg-orange-500');
             document.getElementById('status-indicator').classList.add('bg-red-500');

            const alertLocation = L.latLng(wanderingPath[0]);
            const popupContent = `<div class="font-sans"><div class="font-bold text-base mb-1 text-red-600">系統警報</div><p>偵測到異常行走模式！</p></div>`;
            
            alertMarker = L.marker(alertLocation, {
                icon: L.divIcon({
                    className: 'alert-icon',
                    html: `<div class="relative"><svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-red-500 drop-shadow-lg animate-ping" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-8a7 7 0 1114 0 7 7 0 01-14 0z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 4a1 1 0 011 1v4a1 1 0 11-2 0V5a1 1 0 011-1zm0 8a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg></div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 40]
                })
            }).addTo(map)
              .bindPopup(popupContent)
              .openPopup();
            map.flyTo(alertLocation, 17);
        }

        function resetSimulationButton() {
            document.getElementById('start-simulation').disabled = false;
            document.getElementById('simulation-text').textContent = "重新模擬";
            document.getElementById('status-indicator').className = 'w-4 h-4 bg-green-500 rounded-full animate-pulse';
        }

        // --- 事件監聽 ---
        document.getElementById('start-simulation').addEventListener('click', startSimulation);
        document.getElementById('recenter-btn').addEventListener('click', () => {
            map.flyTo(patientMarker.getLatLng(), 16);
        });
        window.onload = function() { initializeMap(); };
    </script>
</body>
</html>


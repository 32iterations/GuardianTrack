<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>GuardianTrack - 即時定位</title>
    <!-- Leaflet.js CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <style>
        /* 確保地圖填滿框架 */
        #map-container {
            height: 100%;
            width: 100%;
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 10;
        }
        /* 美化 Leaflet 控制項 */
        .leaflet-control-zoom {
            border: none !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .leaflet-control-zoom a {
            background-color: white !important;
            color: #333 !important;
        }
        /* 自訂患者標記點 */
        .patient-marker {
            width: 20px;
            height: 20px;
            background-color: #3b82f6; /* 藍色 */
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }
        .patient-marker.warning {
            background-color: #f97316; /* 橘色警告 */
            box-shadow: 0 0 15px rgba(249, 115, 22, 1);
        }
        /* 起點/終點圖示跳動動畫 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .home-icon, .destination-icon {
            animation: pulse 2s infinite;
        }
        /* Toast 通知動畫 */
        @keyframes slide-in-bottom {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-notification {
            animation: slide-in-bottom 0.5s ease-out forwards;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <!-- 手機 UI 框架 -->
    <div class="w-full max-w-sm h-[800px] bg-gray-100 rounded-3xl shadow-2xl overflow-hidden flex flex-col border-4 border-black">
        
        <!-- 主要內容區域 (地圖和浮動UI) -->
        <main class="flex-1 relative">
            
            <!-- 地圖容器 -->
            <div id="map-container">
                <div id="map"></div>
            </div>

            <!-- 浮動頂部導覽列 -->
            <header class="absolute top-0 left-0 right-0 p-4 z-20">
                <div class="bg-white/80 backdrop-blur-md rounded-xl shadow-md p-3 flex items-center justify-between">
                    <a href="./index.html" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                    </a>
                    <h1 class="text-base font-bold text-gray-800">即時定位：<span class="text-blue-600">陳秀英</span></h1>
                    <div class="w-10 h-10"></div> <!-- 佔位符 -->
                </div>
            </header>
            
            <!-- 浮動底部資訊與控制卡片 -->
            <div class="absolute bottom-0 left-0 right-0 p-4 z-20">
                <div class="bg-white rounded-2xl shadow-lg p-4 space-y-3">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-bold text-gray-800">狀態：<span class="text-green-600">監控中</span></p>
                            <p class="text-xs text-gray-500">最後更新：<span id="last-update">剛剛</span></p>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-gray-200 border-2 border-white flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-600"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                        </div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-center">
                        <button id="recenter-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold p-3 rounded-lg text-sm transition-colors">重新置中</button>
                        <button id="call-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold p-3 rounded-lg text-sm transition-colors">撥打電話</button>
                        <button id="start-simulation" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg text-sm transition-colors">開始模擬</button>
                    </div>
                </div>
            </div>

            <!-- Toast 通知 (預設隱藏) -->
            <div id="toast-notification" class="absolute bottom-28 right-4 z-40 w-full max-w-xs bg-white shadow-2xl rounded-lg p-4 hidden toast-notification">
                 <div class="flex items-start space-x-3">
                    <div class="p-2 bg-red-100 rounded-full"><svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">緊急警報</h3>
                        <p class="text-sm text-gray-600">偵測到異常行走模式！</p>
                        <button onclick="showAlertOnMap()" class="mt-2 text-sm font-semibold text-blue-600 hover:underline">查看詳情</button>
                    </div>
                    <button onclick="document.getElementById('toast-notification').classList.add('hidden')"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
            </div>

        </main>
    </div>

    <!-- Leaflet.js JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
    // --- 變數定義 ---
    const homeCoords = [24.8113, 120.9715];
    const destinationCoords = [24.8035, 120.9920];
    const mapCenter = [24.8074, 120.98175];
    const normalPath = [[24.8113, 120.9715], [24.8110, 120.9725], [24.8105, 120.9740], [24.8090, 120.9750], [24.8085, 120.9775], [24.8078, 120.9800], [24.8070, 120.9820], [24.8065, 120.9845], [24.8055, 120.9870], [24.8045, 120.9895], [24.8035, 120.9920]];
    const wanderingPath = [[24.8070, 120.9820], [24.8072, 120.9825], [24.8068, 120.9828], [24.8071, 120.9823], [24.8073, 120.9826], [24.8069, 120.9829], [24.8070, 120.9821]];
    const deviationPointIndex = 6;

    let map;
    let patientMarker;
    let predictionPathLayers = [];
    let normalPathPolyline, warningPathPolyline, alertMarker = null;
    let animationFrameId;

    // --- 初始化函式 ---
    function initializeMap() {
        map = L.map('map', { zoomControl: false }).setView(mapCenter, 15);
        L.control.zoom({ position: 'bottomright' }).addTo(map);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' }).addTo(map);

        L.marker(homeCoords, { icon: L.divIcon({ className: 'home-icon', html: '<div class="w-6 h-6 bg-green-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg></div>', iconSize: [24, 24], iconAnchor: [12, 24] }) }).addTo(map).bindPopup('<b>家 (起點)</b>');
        L.marker(destinationCoords, { icon: L.divIcon({ className: 'destination-icon', html: '<div class="w-6 h-6 bg-red-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 21l-4.95-6.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></div>', iconSize: [24, 24], iconAnchor: [12, 24] }) }).addTo(map).bindPopup('<b>失智據點 (目的地)</b>');
        
        normalPathPolyline = L.polyline(normalPath, { color: 'rgba(100, 100, 100, 0.6)', weight: 3, dashArray: '5, 10' }).addTo(map);
        patientMarker = L.marker(homeCoords, { icon: L.divIcon({ className: 'patient-marker', iconSize: [20, 20] }) }).addTo(map);
    }

    // --- 動畫函式 ---
    function startSimulation() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        if (warningPathPolyline) map.removeLayer(warningPathPolyline);
        if (alertMarker) { map.removeLayer(alertMarker); alertMarker = null; }
        predictionPathLayers.forEach(layer => map.removeLayer(layer));
        predictionPathLayers = [];
        patientMarker.setLatLng(homeCoords);
        patientMarker.getElement().classList.remove('warning');
        document.getElementById('toast-notification').classList.add('hidden');
        document.getElementById('start-simulation').disabled = true;
        document.getElementById('start-simulation').textContent = "模擬中...";

        let startTime = null;
        const totalDuration = 20000;
        const segmentDuration = totalDuration / normalPath.length;

        function animate(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;
            const pathIndex = Math.min(Math.floor(progress / segmentDuration), normalPath.length - 2);
            if (pathIndex >= deviationPointIndex) { startWanderingAnimation(); return; }
            const segmentProgress = (progress % segmentDuration) / segmentDuration;
            const startPoint = normalPath[pathIndex];
            const endPoint = normalPath[pathIndex + 1];
            const lat = startPoint[0] + (endPoint[0] - startPoint[0]) * segmentProgress;
            const lng = startPoint[1] + (endPoint[1] - startPoint[1]) * segmentProgress;
            const currentPos = [lat, lng];
            patientMarker.setLatLng(currentPos);
            map.panTo(currentPos, { animate: true, duration: 0.1 });
            animationFrameId = requestAnimationFrame(animate);
        }
        animationFrameId = requestAnimationFrame(animate);
    }
    
    function startWanderingAnimation() {
        cancelAnimationFrame(animationFrameId);
        const wanderingPoints = [normalPath[deviationPointIndex]];
        warningPathPolyline = L.polyline(wanderingPoints, { color: '#999999', weight: 5, dashArray: '5,5' }).addTo(map);
        
        let startTime = null;
        const wanderDuration = 10000;
        const totalWanderLength = wanderingPath.length;
        const segmentDuration = wanderDuration / totalWanderLength;
        let suspicionTriggered = false;
        let alertTriggered = false;

        function animateWander(timestamp) {
            if (!startTime) startTime = timestamp;
            const progress = timestamp - startTime;

            if (progress > 3000 && !suspicionTriggered) {
                patientMarker.getElement().classList.add('warning');
                if (warningPathPolyline) {
                    warningPathPolyline.setStyle({ color: '#f97316', dashArray: null, weight: 4 });
                }
                suspicionTriggered = true;
            }

            if (progress > 6000 && !alertTriggered) {
                showToast();
                alertTriggered = true;
            }

            if(progress >= wanderDuration) { resetSimulationButton(); return; }
            
            const pathIndex = Math.min(Math.floor(progress / segmentDuration), totalWanderLength - 2);
            const segmentProgress = (progress % segmentDuration) / segmentDuration;
            const startPoint = wanderingPath[pathIndex];
            const endPoint = wanderingPath[pathIndex + 1];
            const lat = startPoint[0] + (endPoint[0] - startPoint[0]) * segmentProgress;
            const lng = startPoint[1] + (endPoint[1] - startPoint[1]) * segmentProgress;
            const currentPos = [lat, lng];
            patientMarker.setLatLng(currentPos);
            warningPathPolyline.addLatLng(currentPos);
            animationFrameId = requestAnimationFrame(animateWander);
        }
        animationFrameId = requestAnimationFrame(animateWander);
    }
    
    function showToast() {
        document.getElementById('toast-notification').classList.remove('hidden');
    }

    function showAlertOnMap() {
        if (alertMarker) { map.removeLayer(alertMarker); }
        const alertLocation = L.latLng(wanderingPath[0]);
        const popupContent = `<div class="w-64"><div class="font-bold text-base mb-1 text-red-600">系統警報</div><p class="text-sm">偵測到異常行走模式！</p><p class="text-sm mb-2">患者可能已偏離日常路線，並在原地徘徊。請立即確認其狀況。</p><div class="border-t pt-2 mt-2"><p class="font-bold text-xs">最後位置:</p><p class="text-xs">新竹市東區中央路 65 號附近</p><p class="text-xs text-gray-500">(座標: ${alertLocation.lat.toFixed(4)}, ${alertLocation.lng.toFixed(4)})</p></div></div>`;
        
        alertMarker = L.marker(alertLocation, {
            icon: L.divIcon({
                className: 'alert-icon',
                html: `<div class="relative"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-red-500 drop-shadow-lg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-7-8a7 7 0 1114 0 7 7 0 01-14 0z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M10 4a1 1 0 011 1v4a1 1 0 11-2 0V5a1 1 0 011-1zm0 8a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" /></svg></div>`,
                iconSize: [48, 48],
                iconAnchor: [24, 48]
            })
        }).addTo(map)
          .bindPopup(popupContent)
          .openPopup();
            
        document.getElementById('toast-notification').classList.add('hidden');
        map.flyTo(alertLocation, 17);
    }

    function resetSimulationButton() {
        document.getElementById('start-simulation').disabled = false;
        document.getElementById('start-simulation').textContent = "重新模擬";
    }

    function recenterMap() {
        if (patientMarker) {
            map.flyTo(patientMarker.getLatLng(), map.getZoom() < 16 ? 16 : map.getZoom());
        }
    }

    // --- 事件監聽 ---
    document.getElementById('start-simulation').addEventListener('click', startSimulation);
    document.getElementById('recenter-btn').addEventListener('click', recenterMap);
    window.onload = function() { initializeMap(); };
    </script>
</body>
</html>

